clearvars;
close all

database = "TCHEA5";
dependent_element = "Ni";
start_temp = 2000; % in °C
step_size = 1; % in °C
final_solid_frac = 0.99;

[num, txt, raw] = xlsread('Composition.xlsx', 'Sheet1', 'A1:D2');
elementlist = string(txt);
[num, txt, raw] = xlsread('Composition.xlsx', 'Sheet1', 'A2:D2');
wt_pct = double(num);
composition = containers.Map(elementlist, wt_pct); % in wt-%
elements = string(composition.keys());


% relevant_phase = "FCC_L12";

session = tc_toolbox.TCToolbox();

[filepath, name, ext] = fileparts(mfilename("fullpath"));
session.set_cache_folder(name + "_cache");

tc_system = session.select_database_and_elements(database, [dependent_element, elements]).get_system_for_scheil_calculations();

scheil_calculation = tc_system.with_scheil_calculation()...
    .set_composition_unit(tc_toolbox.CompositionUnit.MASS_PERCENT)...
        .with_options(tc_toolbox.scheil.ScheilOptions()...
            .terminate_on_fraction_of_liquid_phase(1 - final_solid_frac))...
        .set_start_temperature(start_temp + 273.15)...
        .set_composition_unit(tc_toolbox.CompositionUnit.MASS_PERCENT);...
        
    
    for element = elements
    scheil_calculation.set_composition(element, composition(element));
end

solidification = scheil_calculation.calculate();

% plot the solidification curve including the equilibrium
scheil_curve = solidification.get_values_grouped_by_stable_phases_of(...
    tc_toolbox.ScheilQuantity.mole_fraction_of_all_solid_phases(),...
    tc_toolbox.ScheilQuantity.temperature());

[mole_fraction_of_solid, temp1] = solidification.get_values_of(...
                            tc_toolbox.ScheilQuantity...
                            .mole_fraction_of_all_solid_phases(),...
                            tc_toolbox.ScheilQuantity.temperature());
                         %.mole_fraction_of_a_solid_phase("*"),...
                         
% Subtract 273 from each temperature and replace the original value
for i = 1:length(temp1)
    temp1(i) = temp1(i) - 273.15;
end

temp_min = 1e6;
temp_max = -1e6;

% Set figure size
figure('Position', [100, 100, 800, 800]);
%figure()
subplot(2,1,1);
sgtitle("Solidification of MPEA Test");
xlabel("Mole fraction of all solid phases [-]");
ylabel("Temperature [°C]");
leg3 = legend;
set(leg3, "Interpreter", "none");
hold on   

for k = scheil_curve.keys()
    label = k{1};  
    section = scheil_curve(label);
    plot(section.get_x(), section.get_y() - 273.15, "DisplayName", ...
        section.get_label(), "LineWidth", 2)
    
    temp_min = min(min(section.get_y()), temp_min);
    temp_max = max(max(section.get_y()), temp_max);
end
xlim([0 1]);
ylim([temp_min temp_max] - 273.15);

 pfx = 'ScheilTest1_Figure_';
 outname = strcat(pfx, '1', '.tif'); %num2str(i)
 exportgraphics(gcf, outname)

